#! /bin/sh
#
# SCRIPT: bldapp
# Builds C applications for Linux, AIX, MacOSX
# Usage: bldapp <prog_name> [ <db_name> [ <userid> <password> ]]

# Select a compiler to use
CC=gcc
#CC=xlc_r

# Set DB2PATH to where DB2 will be accessed.
# The default is the standard instance path.
DB2PATH=/home/db2inst1/sqllib

# Create a githash.h include file
INCFILE=gchash.h
echo "/* This file is automatically generated. */" >$INCFILE

COMMIT_HASH=`git log -1 --pretty=%H`

if [ "$?" == "0" ]
then
  echo "#define COMMIT_HASH \"${COMMIT_HASH}\"" >>$INCFILE
  COMMIT_HASH_ABBREV=`git log -1 --pretty=%h`
  echo "#define COMMIT_HASH_ABBREV \"${COMMIT_HASH_ABBREV}\"" >>$INCFILE
fi

PLAT=`uname -s`

if [ "$PLAT" = "Linux" ]
then
  # Default instance path
  DB2PATH=/home/db2inst1/sqllib
  # Compiler flags
  FLAG1="-DLINUX"  
fi
if [ "$PLAT" = "Darwin" ]
then
  # Default instance path
  DB2PATH=/Users/db2inst1/sqllib
  # Compiler flags
  FLAG1="-DDARWIN"
fi

# Default compiler/linker settings
LIB="lib"

# Determine our bitwidth (32 or 64)
BITWIDTH=`LANG=C db2level | awk '/bits/{print $5}' | cut -b 2-3`

LIB=lib${BITWIDTH}

# Set up compiler switches according to the current environment
if [ "$CC" = "xlc_r" ]
then
  FLAG2="-q${BITWIDTH}"
else
  FLAG2="-m${BITWIDTH}"
fi

# The runtime path is recommended for all applications.
# If you need to use LD_LIBRARY_PATH, unset the RUNTIME
# variable by commenting out the following line.
RUNTIME=true

if [ "$RUNTIME" != "" ]
then
  EXTRA_LFLAG="-Wl,-rpath,$DB2PATH/$LIB"
else
  EXTRA_LFLAG=""
fi

EXTRA_C_FLAGS="$FLAG1 $FLAG2"

# If an embedded SQL program, precompile and bind it.
# Note: some .sqc files contain no SQL but link in 
# utilemb.sqc, so if you get this warning, ignore it:
# SQL0053W  No SQL statements were found in the program.
if [ -f $1".sqc" ]
then
  ./embprep $1 $2 $3 $4
  # Compile the utilemb.c error-checking utility.
  $CC $EXTRA_C_FLAGS -I$DB2PATH/include -c utilemb.c
else
  # Compile the utilapi.c error-checking utility.
  $CC $EXTRA_C_FLAGS -I$DB2PATH/include -c utilapi.c
fi

# Compile the program.
$CC $EXTRA_C_FLAGS -I$DB2PATH/include -c $1.c

if [ -f $1".sqc" ]
then
  # Link the program with utilemb.o.
  $CC $EXTRA_C_FLAGS -o $1 $1.o utilemb.o $EXTRA_LFLAG \
    -L$DB2PATH/$LIB -ldb2
else
  # Link the program with utilapi.o.
  $CC $EXTRA_C_FLAGS -o $1 $1.o utilapi.o $EXTRA_LFLAG \
    -L$DB2PATH/$LIB -ldb2
fi
